!function(n){"use strict";var o,s={settings:{fieldIDs:JSON.parse(wpforms_surveys.field_ids),fieldQueue:"",fieldData:{},charts:{},exportSelects:{}},init:function(){o=this.settings,Chart.defaults.global.defaultFontSize=14,Chart.plugins.register({beforeDraw:function(e){var t=e.chart.ctx;t.fillStyle="white",t.fillRect(0,0,e.chart.width,e.chart.height)}}),n(s.ready),s.buildUIActions()},ready:function(){_.isEmpty(o.fieldIDs)||(o.fieldQueue=o.fieldIDs,_.isEmpty(wpforms_surveys_cache)?s.getFieldData():(o.fieldData=JSON.parse(wpforms_surveys_cache),s.generateReport()))},initExportChoices:function(){n(".survey-chart-export").each(function(){var e=n(this),t=e.data("id");o.exportSelects["export_"+t]=new Choices(e[0],{searchEnabled:!1,shouldSort:!1})})},buildUIActions:function(){n(document).on("click","#wpforms-survey-report .chart-toggle",function(e){e.preventDefault();var e=n(this),t=e.data("type"),a=e.hasClass("current"),r=e.parent(),i=r.data("field-id");a||(r.find(".current").removeClass("current"),e.addClass("current"),o.charts["chart_"+i].destroy(),o.charts["chart_hq_"+i].destroy(),s.generateChart(i,t,o.fieldData["field_"+i].chart.labels,o.fieldData["field_"+i].chart.data),s.generateChart(i,t,o.fieldData["field_"+i].chart.labels,o.fieldData["field_"+i].chart.data,!0))}),n(document).on("change","#wpforms-survey-preview-questions",function(){var e=n(this).val(),e=(o.fieldQueue=[],o.fieldData={},o.fieldQueue.push(e),n("#wpforms-survey-report").empty().prepend(wpforms_surveys.loader),s.getFieldData(),{action:"wpforms_surveys_set_preview_field",nonce:wpforms_admin.nonce,field_id:e,form_id:wpforms_surveys.form_id});n.post(wpforms_admin.ajax_url,e)}),n(document).on("change",".survey-chart-export",function(){var e,t,a=n(this),r=a.data("id");"jpg"===a.val()?((e=(t=n(" #chart-"+r+"-hq")[0]).getContext("2d")).globalCompositeOperation="destination-over",e.fillStyle="rgb(255,255,255)",e.fillRect(0,0,t.scrollWidth,t.scrollHeight),e=t.toDataURL("image/jpeg",1),n("#chart-"+r+"-download").attr("href",e),document.getElementById("chart-"+r+"-download").click()):"pdf"===a.val()?(e=n(" #chart-"+r+"-hq")[0].toDataURL("image/jpeg",1),t={pageSize:"LETTER",content:[{text:o.fieldData["field_"+r].question,fontSize:20,margin:[0,0,0,35]},{image:e,width:530}]},pdfMake.createPdf(t).download("chart-field-"+r+".pdf")):"print"===a.val()&&window.open(wpforms_surveys.print+"&field_id="+r),"1"!==a.val()&&o.exportSelects["export_"+r].setChoiceByValue("1")}),n(document).on("click",".form-details-print-survey-report",function(e){e.preventDefault(),window.open(n(this).attr("href"))}),n(document).on("click","#wpforms-survey-print-close",function(e){e.preventDefault(),window.close()}),n(document).on("click","#wpforms-survey-print",function(e){e.preventDefault(),window.print()}),n(document).on("click","#wpforms-survey-print-preview .question-toggle",function(e){e.preventDefault();var e=n(this),t=e.parent();e.find("i").toggleClass("fa-chevron-down fa-chevron-right"),t.toggleClass("no-print").find(".chart-area, .table-wrap, .stats, .no-answers").toggle()})},getFieldData:function(){var t=_.first(o.fieldQueue),e={action:"wpforms_surveys_field_data",nonce:wpforms_admin.nonce,form_id:wpforms_surveys.form_id,field_id:t,entry_count:wpforms_surveys.entry_count};n.post(wpforms_admin.ajax_url,e,function(e){e.success?(WPFormsAdmin.debug(e.data),o.fieldData["field_"+e.data.id]=e.data,o.fieldQueue=_.without(o.fieldQueue,t),_.isEmpty(o.fieldQueue)?(s.cacheFieldData(),s.generateReport()):s.getFieldData()):(n("#wpforms-survey-loading").remove(),n("#wpforms-survey-report").append(wpforms_surveys.l10n.fetch_error))})},cacheFieldData:function(){var e={action:"wpforms_surveys_cache_fields",nonce:wpforms_admin.nonce,field_data:JSON.stringify(o.fieldData),form_id:wpforms_surveys.form_id,field_id:wpforms_surveys.field_id,entry_count:wpforms_surveys.entry_count};n.post(wpforms_admin.ajax_url,e)},generateReport:function(){n("#wpforms-survey-loading").remove();var e=wp.template("wpforms-question-results");n("#wpforms-survey-report").append(e(o.fieldData)),n.each(o.fieldData,function(e,t){_.isEmpty(t.chart.data)||(s.generateChart(t.id,t.chart.default,t.chart.labels,t.chart.data),s.generateChart(t.id,t.chart.default,t.chart.labels,t.chart.data,!0))}),n(".wpforms-table-sorting").stupidtable(),s.initExportChoices(),"list"===wpforms_surveys.type&&n("#wpforms-survey-preview .btn-wrap").show()},generateChart:function(a,e,t,r,i){var n=!1,i=i||!1;"bar"===e?n={type:"bar",data:{labels:t,datasets:[{label:"Data",hoverBackgroundColor:"#2b8fd2",backgroundColor:"rgba(215, 215, 215, 0.65)",data:r}]},options:{responsive:!i,maintainAspectRatio:!1,legend:{display:!1},tooltips:{callbacks:{title:function(e,t){return t.labels[e[0].index]},label:function(e){return e.yLabel+"% ("+o.fieldData["field_"+a].chart.totals[e.index]+")"}}},scales:{xAxes:[{gridLines:{display:!1},ticks:{fontSize:i?20:14,callback:function(e){return"string"==typeof e&&20<e.length?e.substring(0,20)+"...":e}}}],yAxes:[{ticks:{min:0,max:100,stepSize:20,fontColor:"#999999",fontSize:i?20:11,callback:function(e){return e+"%"}}}]}}}:"bar-h"===e?n={type:"horizontalBar",data:{labels:t,datasets:[{label:"Data",hoverBackgroundColor:"#2b8fd2",backgroundColor:"rgba(215, 215, 215, 0.65)",data:r}]},options:{responsive:!i,maintainAspectRatio:!1,legend:{display:!1},tooltips:{callbacks:{title:function(e,t){return t.labels[e[0].index]},label:function(e){return e.xLabel+"% ("+o.fieldData["field_"+a].chart.totals[e.index]+")"}}},scales:{xAxes:[{ticks:{min:0,max:100,fontColor:"#999999",fontSize:i?20:11,callback:function(e){return e+"%"}}}],yAxes:[{gridLines:{display:!1},ticks:{fontSize:i?20:14,callback:function(e){return"string"==typeof e&&20<e.length?e.substring(0,20)+"...":e}}}]}}}:"pie"===e?n={type:"pie",data:{labels:t,datasets:[{hoverBackgroundColor:"#2b8fd2",data:r,backgroundColor:randomColor({luminosity:"light",count:r.length})}]},options:{responsive:!i,maintainAspectRatio:!1,legend:{position:"right",labels:{fontSize:i?20:14,padding:15,generateLabels:function(d){var c=d.data;return c.labels.length&&c.datasets.length?c.labels.map(function(e,t){var a=d.getDatasetMeta(0),r=c.datasets[0],i=a.data[t],i=i&&i.custom||{},n=Chart.helpers.valueAtIndexOrDefault,o=d.options.elements.arc,s=i.backgroundColor||n(r.backgroundColor,t,o.backgroundColor),l=i.borderColor||n(r.borderColor,t,o.borderColor),i=i.borderWidth||n(r.borderWidth,t,o.borderWidth);return{text:e=20<e.length?e.substring(0,20)+"...":e,fillStyle:s,strokeStyle:l,lineWidth:i,hidden:isNaN(r.data[t])||a.data[t].hidden,index:t}}):[]}}},tooltips:{callbacks:{label:function(e,t){return t.labels[e.index]+" - "+t.datasets[0].data[e.index]+"% ("+o.fieldData["field_"+a].chart.totals[e.index]+")"}}}}}:"line"===e&&(n={type:"line",data:{labels:t,datasets:[{label:"Data",borderColor:"#2b8fd2",backgroundColor:"rgba(215, 215, 215, 0.65)",fill:!1,data:r}]},options:{responsive:!i,maintainAspectRatio:!1,legend:{display:!1},tooltips:{callbacks:{title:function(e,t){return t.labels[e[0].index]},label:function(e){return e.yLabel+"% ("+o.fieldData["field_"+a].chart.totals[e.index]+")"}}},scales:{xAxes:[{gridLines:{display:!1},ticks:{fontSize:i?20:14,callback:function(e){return"string"==typeof e&&20<e.length?e.substring(0,20)+"...":e}}}],yAxes:[{ticks:{min:0,max:100,stepSize:20,fontColor:"#999999",fontSize:i?20:11,callback:function(e){return e+"%"}}}]}}}),n&&(i?o.charts["chart_hq_"+a]=new Chart("chart-"+a+"-hq",n):o.charts["chart_"+a]=new Chart("chart-"+a,n))}};s.init()}(jQuery);